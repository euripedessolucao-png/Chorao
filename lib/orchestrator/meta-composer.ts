import { countPoeticSyllables } from "@/lib/validation/syllable-counter"
import {
  type TerceiraViaAnalysis,
  analisarTerceiraVia,
  applyTerceiraViaToLine,
  ThirdWayEngine,
} from "@/lib/terceira-via"
import { getGenreConfig } from "@/lib/genre-config"
import { generateText } from "ai"
import {
  formatSertanejoPerformance,
  shouldUsePerformanceFormat,
} from "@/lib/formatters/sertanejo-performance-formatter"
import { MultiGenerationEngine } from "./multi-generation-engine"
import { WordIntegrityValidator } from "@/lib/validation/word-integrity-validator"
import { UltimateFixer } from "@/lib/validation/ultimate-fixer"
import { LyricsAuditor } from "@/lib/validation/lyrics-auditor"
import { AbsoluteSyllableEnforcer } from "@/lib/validation/absolute-syllable-enforcer"
import { PunctuationValidator } from "@/lib/validation/punctuation-validator"

export interface CompositionRequest {
  genre: string
  theme: string
  mood: string
  additionalRequirements?: string
  creativity?: "conservador" | "equilibrado" | "ousado"
  syllableTarget?: {
    min: number
    max: number
    ideal: number
  }
  applyFinalPolish?: boolean
  preservedChoruses?: string[]
  originalLyrics?: string
  rhythm?: string
  structureAnalysis?: any
  performanceMode?: "standard" | "performance"
  useTerceiraVia?: boolean
}

export interface CompositionResult {
  lyrics: string
  title: string
  metadata: {
    iterations: number
    finalScore: number
    polishingApplied?: boolean
    preservedChorusesUsed?: boolean
    rhymeScore?: number
    rhymeTarget?: number
    structureImproved?: boolean
    terceiraViaAnalysis?: TerceiraViaAnalysis
    melodicAnalysis?: any
    performanceMode?: string
  }
}

export class MetaComposer {
  private static readonly MAX_ITERATIONS = 3
  private static readonly MAX_AUDIT_ATTEMPTS = 5
  private static readonly ABSOLUTE_MAX_SYLLABLES = 11
  private static readonly MIN_QUALITY_SCORE = 0.75

  /**
   * Obt√©m a configura√ß√£o de s√≠labas para um g√™nero espec√≠fico
   */
  private static getGenreSyllableConfig(genre: string): { min: number; max: number; ideal: number } {
    const genreConfig = getGenreConfig(genre)
    const syllableRules = genreConfig.prosody_rules?.syllable_count

    // Handle different syllable count structures across genres
    if (syllableRules && "absolute_max" in syllableRules) {
      // Sertanejo Moderno structure
      return {
        min: 7,
        max: syllableRules.absolute_max,
        ideal: 10,
      }
    } else if (syllableRules && "without_comma" in syllableRules) {
      // Other genres structure
      return {
        min: syllableRules.without_comma.min,
        max: syllableRules.without_comma.acceptable_up_to,
        ideal: Math.floor((syllableRules.without_comma.min + syllableRules.without_comma.max) / 2),
      }
    }

    // Default fallback
    return {
      min: 7,
      max: 11,
      ideal: 10,
    }
  }

  /**
   * COMPOSI√á√ÉO TURBO COM SISTEMA DE M√öLTIPLES GERA√á√ïES
   *
   * Replica a l√≥gica do gerador de refr√£o:
   * - Gera 3-5 vers√µes de cada elemento
   * - Escolhe a MELHOR de cada
   * - NUNCA entrega letra com erros!
   */
  static async compose(request: CompositionRequest): Promise<CompositionResult> {
    console.log("[v0] üéº MetaComposer.compose - IN√çCIO")
    console.log("[v0] üìä Request:", {
      genre: request.genre,
      theme: request.theme,
      isRewrite: !!request.originalLyrics,
      hasPreservedChoruses: request.preservedChoruses && request.preservedChoruses.length > 0,
    })

    try {
      console.log("[v0] üîÑ Chamando MultiGenerationEngine...")
      const multiGenResult = await MultiGenerationEngine.generateMultipleVariations(
        async () => {
          console.log("[v0] üìù Gerando vers√£o √∫nica...")
          return await this.generateSingleVersion(request)
        },
        (lyrics) => {
          const auditResult = LyricsAuditor.audit(lyrics, request.genre, request.theme)
          console.log("[v0] üìä Score da varia√ß√£o:", auditResult.score)
          return auditResult.score
        },
        3,
      )

      console.log("[v0] ‚úÖ MultiGenerationEngine retornou", multiGenResult.variations.length, "varia√ß√µes")
      console.log(
        "[v0] üèÜ Melhor varia√ß√£o: √≠ndice",
        multiGenResult.bestVariationIndex,
        "- Score:",
        multiGenResult.bestScore,
      )

      const bestLyrics = multiGenResult.variations[multiGenResult.bestVariationIndex].lyrics
      const bestScore = multiGenResult.bestScore

      console.log(`[MetaComposer-TURBO] üèÜ Melhor vers√£o escolhida! Score: ${bestScore}/100`)

      return {
        lyrics: bestLyrics,
        title: this.extractTitle(bestLyrics, request),
        metadata: {
          iterations: 3,
          finalScore: bestScore,
          polishingApplied: request.applyFinalPolish ?? true,
          preservedChorusesUsed: request.preservedChoruses ? request.preservedChoruses.length > 0 : false,
          performanceMode: request.performanceMode || "standard",
        },
      }
    } catch (error) {
      console.error("[v0] ‚ùå MetaComposer.compose - ERRO:", error)
      console.error("[v0] üìç Local do erro: MultiGenerationEngine")
      console.error("[v0] üîÑ Tentando fallback direto...")

      const syllableEnforcement = request.syllableTarget || this.getGenreSyllableConfig(request.genre)
      syllableEnforcement.max = Math.min(syllableEnforcement.max, this.ABSOLUTE_MAX_SYLLABLES)

      try {
        console.log("[v0] üîß Fallback: generateDirectLyrics")
        const fallbackLyrics = await this.generateDirectLyrics(request, syllableEnforcement)
        console.log("[v0] ‚úÖ Fallback bem-sucedido - Letra gerada")

        return {
          lyrics: fallbackLyrics,
          title: this.extractTitle(fallbackLyrics, request),
          metadata: {
            iterations: 1,
            finalScore: 70,
            polishingApplied: false,
            preservedChorusesUsed: false,
            performanceMode: request.performanceMode || "standard",
          },
        }
      } catch (fallbackError) {
        console.error("[v0] üí• Fallback TAMB√âM FALHOU:", fallbackError)
        console.error("[v0] üö® Usando letra de emerg√™ncia")

        const emergencyLyrics = `[VERSE 1]
${request.theme}
Hist√≥ria come√ßa aqui
Tudo vai dar certo

[CHORUS]
${request.theme}
Vai ficar tudo bem
Acredite nisso

[VERSE 2]
Caminho √© longo
Mas vamos chegar
Juntos at√© o fim

[CHORUS]
${request.theme}
Vai ficar tudo bem
Acredite nisso`

        return {
          lyrics: emergencyLyrics,
          title: request.theme,
          metadata: {
            iterations: 0,
            finalScore: 50,
            polishingApplied: false,
            preservedChorusesUsed: false,
            performanceMode: request.performanceMode || "standard",
          },
        }
      }
    }
  }

  /**
   * GERA UMA VERS√ÉO COMPLETA DA LETRA
   * M√©todo auxiliar usado pelo sistema de m√∫ltiplas gera√ß√µes
   */
  private static async generateSingleVersion(request: CompositionRequest): Promise<string> {
    console.log("[MetaComposer] üìù Gerando vers√£o √∫nica...")

    const applyFinalPolish = request.applyFinalPolish ?? true
    const preservedChoruses = request.preservedChoruses || []
    const hasPreservedChoruses = preservedChoruses.length > 0
    const isRewrite = !!request.originalLyrics
    const performanceMode = request.performanceMode || "standard"
    const useTerceiraVia = request.useTerceiraVia ?? true // ‚úÖ AGORA √â AUTOM√ÅTICA

    const syllableEnforcement = request.syllableTarget || this.getGenreSyllableConfig(request.genre)
    syllableEnforcement.max = Math.min(syllableEnforcement.max, this.ABSOLUTE_MAX_SYLLABLES)

    if (syllableEnforcement.max > this.ABSOLUTE_MAX_SYLLABLES) {
      console.warn(`[MetaComposer] ‚ö†Ô∏è TENTATIVA DE BURLAR REGRA UNIVERSAL! For√ßando max=${this.ABSOLUTE_MAX_SYLLABLES}`)
      syllableEnforcement.max = this.ABSOLUTE_MAX_SYLLABLES
    }
    if (syllableEnforcement.ideal > this.ABSOLUTE_MAX_SYLLABLES) {
      console.warn(`[MetaComposer] ‚ö†Ô∏è IDEAL ACIMA DO LIMITE! Ajustando ideal=${this.ABSOLUTE_MAX_SYLLABLES}`)
      syllableEnforcement.ideal = this.ABSOLUTE_MAX_SYLLABLES
    }

    const genreConfig = getGenreConfig(request.genre)

    // Gera letra base
    let rawLyrics: string

    console.log("[MetaComposer] üîß PR√â-GERA√á√ÉO: Aplicando UltimateFixer preventivo...")
    if (isRewrite && request.originalLyrics) {
      try {
        request.originalLyrics = UltimateFixer.fixFullLyrics(request.originalLyrics)
        console.log("[MetaComposer] ‚úÖ Letra original corrigida antes da reescrita")
      } catch (error) {
        console.error("[MetaComposer] ‚ùå Erro ao corrigir letra original:", error)
        console.log("[MetaComposer] ‚ö†Ô∏è Usando letra original sem corre√ß√£o")
      }
    }

    if (isRewrite) {
      rawLyrics = await this.generateRewrite(request)
    } else if (hasPreservedChoruses) {
      rawLyrics = await this.generateWithPreservedChoruses(preservedChoruses, request, syllableEnforcement)
    } else {
      rawLyrics = await this.generateDirectLyrics(request, syllableEnforcement)
    }

    console.log("[MetaComposer] üîß P√ìS-GERA√á√ÉO: Aplicando UltimateFixer...")
    try {
      rawLyrics = UltimateFixer.fixFullLyrics(rawLyrics)
      console.log("[MetaComposer] ‚úÖ Letra corrigida ap√≥s gera√ß√£o")
    } catch (error) {
      console.error("[MetaComposer] ‚ùå Erro ao corrigir letra ap√≥s gera√ß√£o:", error)
      console.log("[MetaComposer] ‚ö†Ô∏è Usando letra sem corre√ß√£o p√≥s-gera√ß√£o")
    }

    console.log("[MetaComposer] üîç VALIDA√á√ÉO IMEDIATA: Verificando regra universal de 11 s√≠labas...")
    const immediateValidation = AbsoluteSyllableEnforcer.validate(rawLyrics)
    if (!immediateValidation.isValid) {
      console.error("[MetaComposer] ‚ùå LETRA GERADA VIOLOU REGRA UNIVERSAL DE 11 S√çLABAS!")
      console.error(immediateValidation.message)

      const forceFixResult = AbsoluteSyllableEnforcer.validateAndFix(rawLyrics)
      rawLyrics = forceFixResult.correctedLyrics

      if (!forceFixResult.isValid) {
        console.error("[MetaComposer] ‚ùå CORRE√á√ÉO FOR√áADA FALHOU! Aplicando UltimateFixer novamente...")
        try {
          rawLyrics = UltimateFixer.fixFullLyrics(rawLyrics)
          console.log("[MetaComposer] ‚úÖ UltimateFixer aplicado com sucesso")
        } catch (error) {
          console.error("[MetaComposer] ‚ùå UltimateFixer falhou:", error)
        }
      }
    }

    // TERCEIRA VIA AGORA √â AUTOM√ÅTICA
    const terceiraViaAnalysis = analisarTerceiraVia(rawLyrics, request.genre, request.theme)

    if (terceiraViaAnalysis && terceiraViaAnalysis.score_geral < 75) {
      rawLyrics = await this.applyTerceiraViaCorrections(rawLyrics, request, terceiraViaAnalysis, genreConfig)

      console.log("[MetaComposer] üîß Aplicando UltimateFixer ap√≥s Terceira Via...")
      try {
        rawLyrics = UltimateFixer.fixFullLyrics(rawLyrics)
        console.log("[MetaComposer] ‚úÖ UltimateFixer p√≥s-Terceira Via aplicado")
      } catch (error) {
        console.error("[MetaComposer] ‚ùå Erro ao aplicar UltimateFixer p√≥s-Terceira Via:", error)
      }

      const absoluteValidationAfterTerceiraVia = AbsoluteSyllableEnforcer.validate(rawLyrics)
      if (!absoluteValidationAfterTerceiraVia.isValid) {
        console.warn("[MetaComposer] ‚ö†Ô∏è TERCEIRA VIA GEROU VERSOS COM MAIS DE 11 S√çLABAS!")
        console.warn(absoluteValidationAfterTerceiraVia.message)

        const fixResult = AbsoluteSyllableEnforcer.validateAndFix(rawLyrics)
        if (fixResult.isValid) {
          rawLyrics = fixResult.correctedLyrics
        } else {
          console.warn("[MetaComposer] ‚ö†Ô∏è Usando letra da Terceira Via com corre√ß√µes parciais")
          rawLyrics = fixResult.correctedLyrics
        }
      }
    }

    // Polimento final
    let finalLyrics = rawLyrics

    if (applyFinalPolish) {
      finalLyrics = await this.applyUniversalPolish(
        finalLyrics,
        request.genre,
        request.theme,
        syllableEnforcement,
        performanceMode,
        genreConfig,
      )

      console.log("[MetaComposer] üîß Aplicando UltimateFixer ap√≥s polimento...")
      try {
        finalLyrics = UltimateFixer.fixFullLyrics(finalLyrics)
        console.log("[MetaComposer] ‚úÖ UltimateFixer p√≥s-polimento aplicado")
      } catch (error) {
        console.error("[MetaComposer] ‚ùå Erro ao aplicar UltimateFixer p√≥s-polimento:", error)
      }

      const absoluteValidationAfterPolish = AbsoluteSyllableEnforcer.validate(finalLyrics)
      if (!absoluteValidationAfterPolish.isValid) {
        console.warn("[MetaComposer] ‚ö†Ô∏è POLIMENTO GEROU VERSOS COM MAIS DE 11 S√çLABAS!")
        console.warn(absoluteValidationAfterPolish.message)

        const fixResult = AbsoluteSyllableEnforcer.validateAndFix(finalLyrics)
        if (fixResult.isValid) {
          finalLyrics = fixResult.correctedLyrics
        } else {
          console.warn("[MetaComposer] ‚ö†Ô∏è Usando letra polida com corre√ß√µes parciais")
          finalLyrics = fixResult.correctedLyrics
        }
      }
    }

    // Valida√ß√£o de pontua√ß√£o
    const punctuationResult = PunctuationValidator.validate(finalLyrics)
    if (!punctuationResult.isValid) {
      finalLyrics = punctuationResult.correctedLyrics
    }

    console.log("[MetaComposer] üîß CORRE√á√ÉO FINAL: Aplicando UltimateFixer final...")
    try {
      finalLyrics = UltimateFixer.fixFullLyrics(finalLyrics)
      console.log("[MetaComposer] ‚úÖ Corre√ß√£o final aplicada")
    } catch (error) {
      console.error("[MetaComposer] ‚ùå Erro na corre√ß√£o final:", error)
      console.log("[MetaComposer] ‚ö†Ô∏è Usando letra sem corre√ß√£o final")
    }

    console.log("[MetaComposer] üîç VALIDA√á√ÉO FINAL ABSOLUTA: Verificando regra universal de 11 s√≠labas...")
    const finalAbsoluteValidation = AbsoluteSyllableEnforcer.validate(finalLyrics)
    if (!finalAbsoluteValidation.isValid) {
      console.error("[MetaComposer] ‚ùå VALIDA√á√ÉO FINAL FALHOU - LETRA VIOLA REGRA UNIVERSAL!")
      console.error(finalAbsoluteValidation.message)

      console.log("[MetaComposer] üö® APLICANDO CORRE√á√ÉO DE EMERG√äNCIA...")
      const emergencyFix = AbsoluteSyllableEnforcer.validateAndFix(finalLyrics)
      finalLyrics = emergencyFix.correctedLyrics

      if (!emergencyFix.isValid) {
        console.error("[MetaComposer] ‚ùå CORRE√á√ÉO DE EMERG√äNCIA FALHOU!")
        console.error("[MetaComposer] ‚ö†Ô∏è RETORNANDO LETRA COM AVISOS CR√çTICOS")
      } else {
        console.log("[MetaComposer] ‚úÖ CORRE√á√ÉO DE EMERG√äNCIA BEM-SUCEDIDA!")
      }
    } else {
      console.log("[MetaComposer] ‚úÖ LETRA APROVADA - TODOS OS VERSOS T√äM NO M√ÅXIMO 11 S√çLABAS!")
    }

    // Valida√ß√£o de integridade de palavras
    const integrityCheck = WordIntegrityValidator.validate(finalLyrics)
    if (!integrityCheck.isValid) {
      console.warn("[MetaComposer] ‚ö†Ô∏è Vers√£o com problemas de integridade detectados:")
      integrityCheck.errors.forEach((error) => {
        if (error.suggestion) {
          console.warn(`  - Linha ${error.lineNumber}: "${error.word}" ‚Üí sugest√£o: "${error.suggestion}"`)
        } else {
          console.warn(`  - Linha ${error.lineNumber}: "${error.word}" parece incompleta`)
        }
      })
      console.warn("[MetaComposer] ‚ö†Ô∏è Retornando letra com avisos de integridade")
    } else {
      console.log("[MetaComposer] ‚úÖ Vers√£o aprovada - Integridade de palavras OK")
    }

    console.log("[v0] üéâ MetaComposer.compose - SUCESSO")
    return finalLyrics
  }

  /**
   * APLICA CORRE√á√ïES BASEADAS NA AN√ÅLISE TERCEIRA VIA
   */
  private static async applyTerceiraViaCorrections(
    lyrics: string,
    request: CompositionRequest,
    analysis: TerceiraViaAnalysis,
    genreConfig: any,
  ): Promise<string> {
    const lines = lyrics.split("\n")
    const correctedLines: string[] = []
    let correctionsApplied = 0

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i]

      // S√ì CORRIGE LINHAS QUE PRECISAM
      if (this.needsTerceiraViaCorrection(line, analysis)) {
        try {
          const context = this.buildLineContext(lines, i, "")
          const correctedLine = await applyTerceiraViaToLine(
            line,
            i,
            context,
            false,
            "",
            request.genre,
            genreConfig, // ‚Üê PAR√ÇMETRO QUE ESTAVA FALTANDO!
          )

          if (correctedLine !== line) {
            correctionsApplied++
            console.log(`[TerceiraVia] üîÑ Linha ${i} corrigida: "${line}" ‚Üí "${correctedLine}"`)
          }

          correctedLines.push(correctedLine)
        } catch (error) {
          console.warn(`[TerceiraVia] ‚ùå Erro na linha ${i}, mantendo original`)
          correctedLines.push(line)
        }
      } else {
        correctedLines.push(line)
      }
    }

    console.log(`[MetaComposer-TURBO] ‚úÖ ${correctionsApplied} corre√ß√µes Terceira Via aplicadas`)
    return correctedLines.join("\n")
  }

  /**
   * POLIMENTO UNIVERSAL COM TERCEIRA VIA
   */
  private static async applyUniversalPolish(
    lyrics: string,
    genre: string,
    theme: string,
    syllableTarget: { min: number; max: number; ideal: number },
    performanceMode = "standard",
    genreConfig: any,
  ): Promise<string> {
    console.log(`[MetaComposer-TURBO] ‚ú® Polimento universal para: ${genre} (${performanceMode})`)

    let polishedLyrics = lyrics

    // ETAPA 1: CORRE√á√ÉO DE RIMAS COM TERCEIRA VIA
    polishedLyrics = await this.applyRhymeEnhancement(polishedLyrics, genre, theme)

    // ETAPA 2: CORRE√á√ÉO DE S√çLABAS INTELIGENTE
    const lines = polishedLyrics.split("\n")
    const finalLines: string[] = []

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i]

      if (line.startsWith("[") || line.startsWith("(") || line.includes("Instruments:") || !line.trim()) {
        finalLines.push(line)
        continue
      }

      const currentSyllables = countPoeticSyllables(line)
      const needsCorrection = currentSyllables < syllableTarget.min || currentSyllables > syllableTarget.max

      if (needsCorrection) {
        try {
          const polishedLine = await ThirdWayEngine.generateThirdWayLine(
            line,
            genre,
            genreConfig,
            `Polimento final para ${genre}`,
            performanceMode === "performance",
            `Ajuste para ${syllableTarget.ideal} s√≠labas po√©ticas`,
          )
          finalLines.push(polishedLine)
        } catch (error) {
          finalLines.push(line)
        }
      } else {
        finalLines.push(line)
      }
    }

    polishedLyrics = finalLines.join("\n")

    if (shouldUsePerformanceFormat(genre, performanceMode)) {
      console.log("[MetaComposer] üé≠ Aplicando formato de performance para sertanejo moderno...")
      polishedLyrics = formatSertanejoPerformance(polishedLyrics)
    } else if (performanceMode === "performance") {
      polishedLyrics = this.applyPerformanceFormatting(polishedLyrics, genre)
    }

    return polishedLyrics
  }

  /**
   * GERA REESCRITA DE LETRA EXISTENTE - MANTENDO ESTRUTURA E TEMA ORIGINAL
   */
  private static async generateRewrite(request: CompositionRequest): Promise<string> {
    console.log("[v0] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
    console.log("[v0] üìù generateRewrite - IN√çCIO")
    console.log("[v0] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
    console.log("[v0] üìä Request completo:", JSON.stringify(request, null, 2))
    console.log("[v0] üìä Original lyrics:", request.originalLyrics?.substring(0, 200) + "...")
    console.log("[v0] üìä Original lyrics length:", request.originalLyrics?.length || 0)

    if (!request.originalLyrics) {
      console.error("[v0] ‚ùå generateRewrite - Letra original n√£o fornecida!")
      throw new Error("Original lyrics required for rewrite")
    }

    const syllableTarget = request.syllableTarget || this.getGenreSyllableConfig(request.genre)
    const genreConfig = getGenreConfig(request.genre)

    const rewritePrompt = `Voc√™ √© um compositor profissional de ${request.genre} especializado em REESCREVER letras mantendo a ess√™ncia original.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìã LETRA ORIGINAL PARA REESCREVER:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${request.originalLyrics}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ INSTRU√á√ïES DE REESCRITA (OBRIGAT√ìRIAS)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**O QUE VOC√ä DEVE FAZER:**

1. **MANTER A ESTRUTURA EXATA:**
   - Mesmo n√∫mero de versos que a original
   - Mesmo n√∫mero de refr√µes que a original
   - Mesmas se√ß√µes (VERSE, CHORUS, BRIDGE, OUTRO)
   - Se a original tem 4 versos, a reescrita TEM 4 versos

2. **MANTER O TEMA E HIST√ìRIA:**
   - Preserve o tema central da letra original
   - Mantenha a narrativa e emo√ß√£o
   - Reescreva cada verso mantendo o SENTIDO original
   - Exemplo: Se o verso fala sobre "carro", mantenha sobre "carro"

3. **MELHORAR A QUALIDADE PO√âTICA:**
   - Ajuste para M√ÅXIMO 11 s√≠labas por verso
   - Melhore as rimas
   - Use linguagem coloquial brasileira (c√™, t√¥, pra)
   - Corrija palavras cortadas ou sem acentos

4. **PRESERVAR PALAVRAS-CHAVE:**
   - Identifique palavras importantes da original
   - Mantenha essas palavras na reescrita
   - Exemplo: "Cavalo de ferro" ‚Üí mantenha "cavalo" e "ferro"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è REGRAS T√âCNICAS ABSOLUTAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. **M√ÅXIMO 11 S√çLABAS** por verso (REGRA ABSOLUTA)
2. **Palavras COMPLETAS** com acentua√ß√£o CORRETA
3. **NUNCA** escreva: "n√£", "seguran√ß", "heran√ß", "ra√ß", "la√ß"
4. **SEMPRE** escreva: "n√£o", "seguran√ßa", "heran√ßa", "ra√ßa", "la√ßo"

**T√âCNICAS PARA REDUZIR S√çLABAS:**
‚úÖ Remover artigos: "o", "a", "um", "uma"
‚úÖ Contra√ß√µes: "pra", "t√°", "t√¥", "c√™"
‚úÖ Simplificar: "que eu tenho" ‚Üí "que tenho"
‚úÖ Encurtar: "por entre os dedos" ‚Üí "entre os dedos"

**MAS NUNCA:**
‚ùå Remover acentos
‚ùå Cortar palavras
‚ùå Criar palavras inexistentes

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù EXEMPLO DE REESCRITA CORRETA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**ORIGINAL:**
[VERSE 1]
Cavalo de ferro que n√£o sabe sentir
Carro na vaga, n√£o sei pra onde ir

**REESCRITA CORRETA:**
[VERSE 1]
Cavalo de ferro sem saber sentir (10 s√≠labas)
Carro parado, sem rumo pra ir (9 s√≠labas)

**REESCRITA ERRADA:**
[VERSE 1]
Vida ingrata (4 s√≠labas - TEMA DIFERENTE!)
Hist√≥ria come√ßa aqui (7 s√≠labas - PERDEU O TEMA!)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**IMPORTANTE:** Voc√™ est√° REESCREVENDO, n√£o criando letra nova!
Mantenha a estrutura, tema e hist√≥ria da original.
Apenas melhore a m√©trica, rimas e qualidade po√©tica.

Retorne APENAS a letra reescrita (sem explica√ß√µes):`

    try {
      console.log("[v0] ü§ñ Chamando AI para reescrita...")
      const response = await generateText({
        model: "openai/gpt-4o",
        prompt: rewritePrompt,
        temperature: 0.5,
      })

      console.log("[v0] ‚úÖ AI retornou resposta - Length:", response.text?.length || 0)
      return response.text || request.originalLyrics
    } catch (error) {
      console.error("[v0] ‚ùå generateRewrite - Erro na AI:", error)
      console.error("[v0] üîÑ Retornando letra original como fallback")
      return request.originalLyrics
    }
  }

  /**
   * GERA LETRA COM REFR√ïES PRESERVADOS
   */
  private static async generateWithPreservedChoruses(
    preservedChoruses: string[],
    request: CompositionRequest,
    syllableEnforcement: { min: number; max: number; ideal: number },
  ): Promise<string> {
    console.log("[MetaComposer] Gerando letra com refr√µes preservados...")

    const syllableTarget = request.syllableTarget || this.getGenreSyllableConfig(request.genre)
    const genreConfig = getGenreConfig(request.genre)

    try {
      const chorusPrompt = `Voc√™ √© um compositor profissional de ${request.genre}. Crie uma letra usando EXATAMENTE estes refr√µes:

${preservedChoruses.join("\n\n")}

TEMA: ${request.theme}
MOOD: ${request.mood}

REGRAS ABSOLUTAS:

1. S√çLABAS: M√°ximo 11 por verso (conte antes de finalizar) - REGRA ABSOLUTA
2. GRAM√ÅTICA: Frases completas em portugu√™s correto
3. VOCABUL√ÅRIO: Use biqu√≠ni, PIX, story, boteco (evite clich√™s dram√°ticos)
4. LINGUAGEM: Coloquial brasileira (t√¥, c√™, pra)
5. NARRATIVA: Hist√≥ria flu√≠da com come√ßo-meio-fim

‚ö†Ô∏è REGRA DE OURO: M√ÅXIMO 11 S√çLABAS POR VERSO - N√ÉO NEGOCI√ÅVEL

Retorne a letra completa com os refr√µes preservados:`

      const response = await generateText({
        model: "openai/gpt-4o",
        prompt: chorusPrompt,
        temperature: 0.7,
      })

      return response.text || ""
    } catch (error) {
      console.error("[MetaComposer] Erro ao gerar letra com refr√µes preservados:", error)
      return ""
    }
  }

  /**
   * GERA LETRA DIRETAMENTE - CONSTRUINDO VERSOS CORRETOS DESDE O IN√çCIO
   */
  private static async generateDirectLyrics(
    request: CompositionRequest,
    syllableEnforcement: { min: number; max: number; ideal: number },
  ): Promise<string> {
    console.log("[MetaComposer] Gerando letra construindo versos corretos desde o in√≠cio...")

    const genreConfig = getGenreConfig(request.genre)

    const directPrompt = `Voc√™ √© um compositor profissional de ${request.genre} que cria MEGA HITS BRASILEIROS.

TEMA: ${request.theme}
MOOD: ${request.mood}
${request.rhythm ? `RITMO: ${request.rhythm}` : ""}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è REGRA CR√çTICA DE ACENTUA√á√ÉO (N√ÉO NEGOCI√ÅVEL)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

NUNCA escreva palavras sem acentos corretos!

‚ùå ERRADO: "n√£", "seguran√ß", "heran√ß", "ra√ß", "la√ß"
‚úÖ CORRETO: "n√£o", "seguran√ßa", "heran√ßa", "ra√ßa", "la√ßo"

Se precisar reduzir s√≠labas, use OUTRAS t√©cnicas:
- Remova artigos: "o", "a", "um", "uma"
- Use contra√ß√µes: "pra", "t√°", "t√¥", "c√™"
- Simplifique frases: "que eu tenho" ‚Üí "que tenho"

MAS NUNCA remova acentos ou corte palavras!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ REGRA DE OURO ATUALIZADA - M√ÅXIMO 11 S√çLABAS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**PRIORIDADE M√ÅXIMA (N√£o negoci√°vel):**
1. ‚úÖ M√ÅXIMO 11 S√çLABAS por verso (REGRA ABSOLUTA)
2. ‚úÖ Palavras COMPLETAS com acentua√ß√£o CORRETA
3. ‚úÖ Emo√ß√£o aut√™ntica e hist√≥ria envolvente

**PRIORIDADE IMPORTANTE:**
4. ‚úÖ Chorus memor√°vel que gruda na cabe√ßa
5. ‚úÖ Linguagem coloquial brasileira (c√™, t√¥, pra)
6. ‚úÖ Frases completas e coerentes

**T√âCNICAS PARA 11 S√çLABAS:**
‚úÖ Remover artigos: "o", "a", "um", "uma"
‚úÖ Contra√ß√µes: "pra", "t√°", "t√¥", "c√™"
‚úÖ Simplificar: "que eu tenho" ‚Üí "que tenho"
‚úÖ Encurtar: "por entre os dedos" ‚Üí "entre os dedos"

**REGRA DE OURO ATUALIZADA:**
EMO√á√ÉO dentro dos LIMITES T√âCNICOS!
Verso perfeito = At√© 11 s√≠labas + Emo√ß√£o + Palavras √≠ntegras

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéµ CARACTER√çSTICAS DOS MEGA HITS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**CHORUS MEMOR√ÅVEL:**
- Frases curtas (m√°ximo 8-9 s√≠labas)
- Extremamente repetitivo
- Gruda na cabe√ßa imediatamente
- F√°cil de cantar junto (karaoke-friendly)

**LINGUAGEM COLOQUIAL:**
- "c√™" ao inv√©s de "voc√™"
- "t√¥" ao inv√©s de "estou"
- "pra" ao inv√©s de "para"
- "t√°" ao inv√©s de "est√°"

**NARRATIVA ENVOLVENTE:**
- Come√ßo-meio-fim claro
- Hist√≥ria que emociona
- Autenticidade (n√£o for√ßado)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è IMPORTANTE - REGRA ABSOLUTA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

NUNCA ENTREGUE VERSOS COM MAIS DE 11 S√çLABAS!
A emo√ß√£o √© importante, mas o limite t√©cnico √© ABSOLUTO.

Se encontrar um verso com 12+ s√≠labas:
‚ùå N√ÉO ENTREGUE
‚úÖ REESCREVA respeitando o limite
‚úÖ USE as t√©cnicas de redu√ß√£o acima

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Retorne APENAS a letra (sem explica√ß√µes):`

    try {
      const response = await generateText({
        model: "openai/gpt-4o",
        prompt: directPrompt,
        temperature: 0.5,
      })

      return response.text || ""
    } catch (error) {
      console.error("[MetaComposer] Erro ao gerar letra direta:", error)
      throw error
    }
  }

  // ... (m√©todos auxiliares mantidos da vers√£o original)

  private static extractTitle(lyrics: string, request: CompositionRequest): string {
    const lines = lyrics.split("\n")

    // Procura por linha de t√≠tulo expl√≠cita
    for (const line of lines) {
      if (line.toLowerCase().includes("t√≠tulo:") || line.toLowerCase().includes("title:")) {
        return line.split(":")[1]?.trim() || "Sem T√≠tulo"
      }
    }

    // Usa primeira linha significativa como t√≠tulo
    for (const line of lines) {
      const cleaned = line.trim()
      if (cleaned && !cleaned.startsWith("[") && !cleaned.startsWith("(") && cleaned.length > 3) {
        return cleaned.substring(0, 50)
      }
    }

    return `${request.theme} - ${request.genre}`
  }

  private static needsTerceiraViaCorrection(line: string, analysis: TerceiraViaAnalysis): boolean {
    // N√£o corrige tags, instru√ß√µes ou linhas vazias
    if (!line.trim() || line.startsWith("[") || line.startsWith("(") || line.includes("Instruments:")) {
      return false
    }

    // Corrige se score geral est√° baixo
    if (analysis.score_geral < 70) {
      return true
    }

    // Corrige se h√° pontos fracos identificados
    if (analysis.pontos_fracos && analysis.pontos_fracos.length > 0) {
      return true
    }

    return false
  }

  private static buildLineContext(lines: string[], lineIndex: number, theme: string): string {
    const contextLines: string[] = []

    // Adiciona linha anterior se existir
    if (lineIndex > 0) {
      contextLines.push(`Linha anterior: ${lines[lineIndex - 1]}`)
    }

    // Adiciona linha atual
    contextLines.push(`Linha atual: ${lines[lineIndex]}`)

    // Adiciona pr√≥xima linha se existir
    if (lineIndex < lines.length - 1) {
      contextLines.push(`Pr√≥xima linha: ${lines[lineIndex + 1]}`)
    }

    contextLines.push(`Tema: ${theme}`)

    return contextLines.join("\n")
  }

  private static async applyRhymeEnhancement(lyrics: string, genre: string, theme: string): Promise<string> {
    console.log("[MetaComposer] Aplicando melhorias de rima...")
    return lyrics
  }

  private static applyPerformanceFormatting(lyrics: string, genre: string): string {
    console.log("[MetaComposer] Aplicando formata√ß√£o perform√°tica...")
    let formatted = lyrics

    // Converte tags comuns para ingl√™s
    formatted = formatted.replace(/\[Intro\]/gi, "[Intro]")
    formatted = formatted.replace(/\[Verso\s*(\d*)\]/gi, "[Verse$1]")
    formatted = formatted.replace(/\[Refr√£o\]/gi, "[Chorus]")
    formatted = formatted.replace(/\[Ponte\]/gi, "[Bridge]")
    formatted = formatted.replace(/\[Final\]/gi, "[Outro]")

    return formatted
  }
}
